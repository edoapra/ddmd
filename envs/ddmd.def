Bootstrap: docker
From: nvidia/cuda:11.3.0-cudnn8-devel-ubuntu20.04

%files
    ddmd.yml /ddmd.yml

%post
    export DEBIAN_FRONTEND=noninteractive
    export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1

    apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 A4B469963BF863CC
    apt-get -y update
    apt-get install -y build-essential  cmake  git  wget openmpi-bin openmpi-doc libopenmpi-dev slurm-client

    wget -q -P /tmp https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash /tmp/Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda

    export PATH="/opt/conda/bin:$PATH"
    conda update -qy conda
    conda env update -n base -f /ddmd.yml
    pip install git+https://github.com/hengma1001/ddmd.git
# cleanup    
    conda clean -y --force-pkgs-dirs
    du -sh /opt/conda/*
    apt-get purge -y --allow-change-held-packages libcublas-dev-11-3 libcufft-dev-11-3 libcusparse-dev-11-3 libcusolver-dev-11-3 libnpp-dev-11-3 libnccl-dev  libcurand-dev-11-3  cuda-cudart-dev-11-3 cuda-nvrtc-dev-11-3 libnvjpeg-dev-11-3 libcudnn8-dev cuda-sanitizer-11-3 cuda-nvdisasm-11-3
    apt-get autoremove -y
    rm -f /tmp/Miniconda3-latest-Linux-x86_64.sh
    df -h
    rm -f /usr/local/cuda-11.3/targets/x86_64-linux/lib/lib*.a
    rm -rf /opt/conda/lib/python*/site-packages/tensorflow/include
    strip --strip-unneeded /usr/local/cuda-11.3/targets/x86_64-linux/lib/*.so.*.*
    apt-get clean -y
    dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n
    df -h . /tmp
    ls -lart /tmp
    du -sk /tmp/*|sort -n
    unset DEBIAN_FRONTEND

%environment
    PATH="/opt/conda/bin:$PATH"

