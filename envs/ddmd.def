Bootstrap: docker
#From: nvidia/cuda:11.3.0-cudnn8-base-ubuntu20.04
#From: nvidia/cuda:11.3.0-runtime-ubuntu20.04
From: nvidia/cuda:11.3.1-runtime-ubuntu20.04

%files
    ddmd.yml /ddmd.yml

%post
    export DEBIAN_FRONTEND=noninteractive
    export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1

    apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 A4B469963BF863CC
    apt-get -y update
    apt-get install -y build-essential  cmake  git  wget openmpi-bin openmpi-doc libopenmpi-dev slurm-client

    TMPDIR=/dev/shm/tmp
    mkdir -p $TMPDIR

    MYPREFIX=/opt/conda
    mkdir -p $MYPREFIX
    df -h /tmp /dev/shm $MYPREFIX
    MINIFORGE3=Miniforge3-Linux-x86_64.sh
    wget -q -P /tmp  https://github.com/conda-forge/miniforge/releases/latest/download/$MINIFORGE3
    bash /tmp/$MINIFORGE3 -b -u -p $MYPREFIX
    rm -f /tmp/$MINIFORGE3

    export PATH="$MYPREFIX/bin:$PATH"
    conda update -qy conda
    conda env update -q -n base -f /ddmd.yml 
    df -h
    pip install git+https://github.com/hengma1001/ddmd.git
# cleanup    
    conda clean -y --force-pkgs-dirs
    du -sh $MYPREFIX/*
    apt-get purge -y --allow-change-held-packages libcublas-dev-11-3 libcufft-dev-11-3 libcusparse-dev-11-3 libcusolver-dev-11-3 libnpp-dev-11-3 libnccl-dev  libcurand-dev-11-3  cuda-cudart-dev-11-3 cuda-nvrtc-dev-11-3 libnvjpeg-dev-11-3 libcudnn8-dev cuda-sanitizer-11-3 cuda-nvdisasm-11-3
    apt-get clean
    apt-get autoremove -y
    df -h
    ls -lrt /usr/local
    rm -f /usr/local/cuda-11.3/targets/x86_64-linux/lib/lib*.a
    rm -rf $MYPREFIX/lib/python*/site-packages/tensorflow/include
    strip --strip-unneeded /usr/local/cuda-11.3/targets/x86_64-linux/lib/*.so.*.*
    apt-get clean -y
    dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n
    df -h . /tmp
    unset DEBIAN_FRONTEND

%environment
    PATH="/opt/conda/bin:$PATH"

