Bootstrap: docker
From: nvidia/cuda:11.3.1-runtime-ubuntu20.04

%files
    ddmd.yml /ddmd.yml

%post
    echo "$(readlink /proc/$$/exe) is the shell in use"

    export DEBIAN_FRONTEND=noninteractive
    export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1

    apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 A4B469963BF863CC
    apt-get -y update
    apt-get install -y build-essential  cmake  git  wget openmpi-bin  libopenmpi-dev slurm-client
    apt-get clean
    wget -q -P /tmp https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
    MYPREFIX=/opt/conda
    bash /tmp/Miniforge3-Linux-x86_64.sh -b -p $MYPREFIX

  eval "$($MYPREFIX/bin/conda shell.dash hook)"
    conda install -y -c conda-forge micromamba
  eval "$(micromamba shell hook --shell dash)"
    micromamba update -y
    micromamba create -y -n ddmd -f ./ddmd.yml
    micromamba activate ddmd 
   pip install git+https://github.com/hengma1001/ddmd.git

    unset DEBIAN_FRONTEND

%environment
    MYPREFIX=/opt/conda
#    PATH="$MYPREFIX/bin:$PATH"
  eval "$($MYPREFIX/bin/conda shell.dash hook)"
  eval "$(micromamba shell hook --shell dash)"
    micromamba activate ddmd 

