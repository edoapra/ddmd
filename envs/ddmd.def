Bootstrap: docker
From: nvidia/cuda:11.3.1-cudnn8-runtime-ubuntu20.04

%files
    ddmd.yml /ddmd.yml

%post
    export DEBIAN_FRONTEND=noninteractive
    export APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1

    apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 A4B469963BF863CC
    apt-get -y update
    apt-get install -y build-essential  cmake  git  wget openmpi-bin openmpi-doc libopenmpi-dev slurm-client

    wget -q -P /tmp https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
    bash /tmp/Miniforge3-Linux-x86_64.sh -b -p /opt/conda

    export PATH="/opt/conda/bin:$PATH"
    conda update -qy conda
    conda env update -n base -f /ddmd.yml
    pip install git+https://github.com/hengma1001/ddmd.git

    unset DEBIAN_FRONTEND

%environment
    PATH="/opt/conda/bin:$PATH"

